{% extends 'admin_templates/base.html' %}
{% load humanize %}
{% load static %}

{% block title %}Venex - Portfolio{% endblock title %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'assets/css/portfolio.css' %}">
{% endblock %}

{% block main_content %}
<div class="portfolio-wrapper">
    <!-- Mobile Header -->
    <div class="mobile-header">
        <button class="menu-toggle" id="menu-toggle">
            <i class="fas fa-bars"></i>
        </button>
        <h1 class="mobile-title">Portfolio</h1>
        <button class="refresh-btn-mobile" id="refresh-mobile">
            <i class="fas fa-sync-alt"></i>
        </button>
    </div>

    <!-- Portfolio Hero -->
    <div class="portfolio-hero">
        <div class="hero-gradient"></div>
        <div class="hero-content">
            <div class="hero-header">
                <div class="hero-title-section">
                    <h1 class="hero-title">
                        <i class="fas fa-chart-pie"></i>
                        <span>My Portfolio</span>
                    </h1>
                    <p class="hero-subtitle">Real-time tracking & analytics</p>
                </div>
                <button class="btn-refresh" id="refresh-btn">
                    <i class="fas fa-sync-alt"></i>
                    <span class="refresh-text">Refresh</span>
                </button>
            </div>

            <!-- Summary Cards -->
            <div class="summary-cards">
                <div class="summary-card total-value">
                    <div class="card-icon">
                        <i class="fas fa-wallet"></i>
                    </div>
                    <div class="card-content">
                        <span class="card-label">Total Value</span>
                        <h2 class="card-value">
                            {{ user.get_currency_symbol }}<span id="total-value">0.00</span>
                        </h2>
                        <span class="card-change positive" id="total-value-change">
                            <i class="fas fa-arrow-up"></i>
                            <span>0.00%</span>
                        </span>
                    </div>
                </div>

                <div class="summary-card total-pl">
                    <div class="card-icon">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="card-content">
                        <span class="card-label">Total P/L</span>
                        <h2 class="card-value" id="total-pl-value">
                            {{ user.get_currency_symbol }}0.00
                        </h2>
                        <span class="card-change" id="total-pl-percentage">0.00%</span>
                    </div>
                </div>

                <div class="summary-card total-invested">
                    <div class="card-icon">
                        <i class="fas fa-hand-holding-usd"></i>
                    </div>
                    <div class="card-content">
                        <span class="card-label">Invested</span>
                        <h2 class="card-value">
                            {{ user.get_currency_symbol }}<span id="total-invested">0.00</span>
                        </h2>
                    </div>
                </div>

                <div class="summary-card total-assets">
                    <div class="card-icon">
                        <i class="fas fa-coins"></i>
                    </div>
                    <div class="card-content">
                        <span class="card-label">Assets</span>
                        <h2 class="card-value" id="total-assets">0</h2>
                        <span class="card-sublabel">Cryptocurrencies</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tab Navigation -->
    <div class="portfolio-tabs">
        <button class="tab-btn active" data-tab="holdings">
            <i class="fas fa-briefcase"></i>
            <span>Holdings</span>
        </button>
        <button class="tab-btn" data-tab="performance">
            <i class="fas fa-chart-bar"></i>
            <span>Performance</span>
        </button>
        <button class="tab-btn" data-tab="allocation">
            <i class="fas fa-pie-chart"></i>
            <span>Allocation</span>
        </button>
        <button class="tab-btn" data-tab="analytics">
            <i class="fas fa-brain"></i>
            <span>Analytics</span>
        </button>
    </div>

    <!-- Tab Contents -->
    <div class="tab-content active" id="holdings-tab">
        <!-- Holdings Section -->
        <div class="section-card">
            <div class="section-header">
                <h2 class="section-title">
                    <i class="fas fa-briefcase"></i>
                    Your Holdings
                </h2>
                <div class="section-actions">
                    <select class="sort-select" id="holdings-sort">
                        <option value="value-desc">Value (High to Low)</option>
                        <option value="value-asc">Value (Low to High)</option>
                        <option value="pl-desc">P/L (High to Low)</option>
                        <option value="pl-asc">P/L (Low to High)</option>
                    </select>
                </div>
            </div>

            <!-- Holdings List -->
            <div class="holdings-list" id="holdings-list">
                <div class="loading-state">
                    <div class="spinner"></div>
                    <p>Loading holdings...</p>
                </div>
            </div>

            <!-- Empty State -->
            <div class="empty-state" id="empty-holdings" style="display: none;">
                <div class="empty-icon">
                    <i class="fas fa-inbox"></i>
                </div>
                <h3>No Holdings Yet</h3>
                <p>Start building your crypto portfolio</p>
                <a href="{% url 'buy' %}" class="btn-primary">
                    <i class="fas fa-plus"></i>
                    Buy Crypto
                </a>
            </div>
        </div>
    </div>

    <div class="tab-content" id="performance-tab">
        <!-- Performance Section -->
        <div class="section-card">
            <div class="section-header">
                <h2 class="section-title">
                    <i class="fas fa-chart-bar"></i>
                    Performance
                </h2>
                <div class="timeframe-selector">
                    <button class="timeframe-btn active" data-period="1D">1D</button>
                    <button class="timeframe-btn" data-period="1W">1W</button>
                    <button class="timeframe-btn" data-period="1M">1M</button>
                    <button class="timeframe-btn" data-period="3M">3M</button>
                    <button class="timeframe-btn" data-period="1Y">1Y</button>
                    <button class="timeframe-btn" data-period="ALL">ALL</button>
                </div>
            </div>

            <!-- Performance Metrics -->
            <div class="performance-metrics">
                <div class="metric-item">
                    <span class="metric-label">Today's Change</span>
                    <span class="metric-value positive" id="today-change">+$0.00</span>
                </div>
                <div class="metric-item">
                    <span class="metric-label">Best Performer</span>
                    <span class="metric-value" id="best-performer">--</span>
                </div>
                <div class="metric-item">
                    <span class="metric-label">Worst Performer</span>
                    <span class="metric-value" id="worst-performer">--</span>
                </div>
            </div>

            <!-- Chart -->
            <div class="chart-wrapper">
                <canvas id="performance-chart"></canvas>
            </div>
        </div>

        <!-- Portfolio History -->
        <div class="section-card">
            <div class="section-header">
                <h2 class="section-title">
                    <i class="fas fa-history"></i>
                    Portfolio History
                </h2>
                <select class="period-select" id="history-period">
                    <option value="7">Last 7 Days</option>
                    <option value="30" selected>Last 30 Days</option>
                    <option value="90">Last 90 Days</option>
                    <option value="365">Last Year</option>
                </select>
            </div>

            <div class="chart-wrapper">
                <canvas id="history-chart"></canvas>
            </div>
        </div>
    </div>

    <div class="tab-content" id="allocation-tab">
        <!-- Allocation Section -->
        <div class="section-card">
            <div class="section-header">
                <h2 class="section-title">
                    <i class="fas fa-pie-chart"></i>
                    Asset Allocation
                </h2>
            </div>

            <!-- Allocation Grid -->
            <div class="allocation-grid" id="allocation-grid">
                <div class="loading-state">
                    <div class="spinner"></div>
                    <p>Loading allocation...</p>
                </div>
            </div>

            <!-- Allocation Chart -->
            <div class="allocation-chart-section">
                <h3 class="subsection-title">Visual Distribution</h3>
                <div class="chart-wrapper doughnut">
                    <canvas id="allocation-chart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="tab-content" id="analytics-tab">
        <!-- Analytics Section -->
        <div class="analytics-wrapper">
            <!-- Risk Analysis -->
            <div class="section-card analytics-card">
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fas fa-exclamation-triangle"></i>
                        Risk Analysis
                    </h2>
                    <span class="ai-badge">
                        <i class="fas fa-robot"></i>
                        AI Powered
                    </span>
                </div>

                <div class="risk-score-container">
                    <div class="risk-circle">
                        <svg class="risk-circle-svg" viewBox="0 0 200 200">
                            <circle class="risk-circle-bg" cx="100" cy="100" r="90"></circle>
                            <circle class="risk-circle-progress" cx="100" cy="100" r="90" id="risk-circle-path"></circle>
                        </svg>
                        <div class="risk-score-content">
                            <span class="risk-score-value" id="risk-score">0</span>
                            <span class="risk-score-label">Risk Score</span>
                        </div>
                    </div>
                    <div class="risk-level-badge" id="risk-level-badge">Calculating...</div>
                </div>

                <div class="risk-breakdown">
                    <div class="risk-item">
                        <span class="risk-label">
                            <i class="fas fa-chart-line"></i>
                            Volatility
                        </span>
                        <span class="risk-value" id="volatility">--</span>
                    </div>
                    <div class="risk-item">
                        <span class="risk-label">
                            <i class="fas fa-project-diagram"></i>
                            Diversification
                        </span>
                        <span class="risk-value" id="diversification">--</span>
                    </div>
                    <div class="risk-item">
                        <span class="risk-label">
                            <i class="fas fa-chart-area"></i>
                            Max Drawdown
                        </span>
                        <span class="risk-value" id="max-drawdown">--</span>
                    </div>
                    <div class="risk-item">
                        <span class="risk-label">
                            <i class="fas fa-percentage"></i>
                            Sharpe Ratio
                        </span>
                        <span class="risk-value" id="sharpe-ratio">--</span>
                    </div>
                </div>
            </div>

            <!-- AI Insights -->
            <div class="section-card insights-card">
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fas fa-lightbulb"></i>
                        AI Insights
                    </h2>
                </div>

                <div class="insights-list" id="insights-list">
                    <div class="loading-state">
                        <div class="spinner"></div>
                        <p>Generating insights...</p>
                    </div>
                </div>
            </div>

            <!-- Performance Metrics -->
            <div class="section-card metrics-card">
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fas fa-tachometer-alt"></i>
                        Performance Metrics
                    </h2>
                </div>

                <div class="metrics-grid">
                    <div class="metric-box">
                        <span class="metric-box-label">Total Return</span>
                        <span class="metric-box-value" id="total-return">--</span>
                    </div>
                    <div class="metric-box">
                        <span class="metric-box-label">Annualized Return</span>
                        <span class="metric-box-value" id="annualized-return">--</span>
                    </div>
                    <div class="metric-box">
                        <span class="metric-box-label">Win Rate</span>
                        <span class="metric-box-value" id="win-rate">--</span>
                    </div>
                    <div class="metric-box">
                        <span class="metric-box-label">Avg. Holding Time</span>
                        <span class="metric-box-value" id="avg-holding">--</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div class="toast-container" id="toast-container"></div>

<!-- Connection Status -->
<div class="connection-status" id="connection-status">
    <i class="fas fa-circle"></i>
    <span>Connected</span>
</div>
{% endblock main_content %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script src="{% static 'assets/js/portfolio.js' %}"></script>
{# WebSocket disabled - using polling for updates instead #}
{# <script src="{% static 'assets/js/portfolioSocket.js' %}"></script> #}
{% endblock %}
