{% extends 'jobs/admin_templates/base.html' %}
{% load humanize %}
{% load static %}

{% block title %}VENEX | Portfolio{% endblock %}

{% block extra_css %}
<style>
    .portfolio-page {
        padding: 0;
    }

    /* Portfolio Summary Cards */
    .portfolio-summary {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .summary-card {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        border-left: 4px solid #667eea;
    }

    .summary-card.performance {
        border-left-color: #10b981;
    }

    .summary-card.risk {
        border-left-color: #f59e0b;
    }

    .summary-card.allocation {
        border-left-color: #8b5cf6;
    }

    .card-value {
        font-size: 2rem;
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 0.5rem;
    }

    .card-label {
        font-size: 0.875rem;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 0.5rem;
    }

    .card-change {
        font-size: 0.875rem;
        font-weight: 600;
        padding: 0.25rem 0.75rem;
        border-radius: 15px;
        display: inline-block;
    }

    .card-change.positive {
        background: #ecfdf5;
        color: #059669;
    }

    .card-change.negative {
        background: #fef2f2;
        color: #dc2626;
    }

    /* Main Layout */
    .portfolio-layout {
        display: grid;
        grid-template-columns: 1fr 400px;
        gap: 2rem;
        margin-bottom: 2rem;
    }

    @media (max-width: 1200px) {
        .portfolio-layout {
            grid-template-columns: 1fr;
        }
    }

    /* Holdings Table */
    .holdings-container {
        background: white;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }

    .table-header {
        padding: 1.5rem;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .table-header h2 {
        font-size: 1.5rem;
        font-weight: 600;
        color: #1f2937;
        margin: 0;
    }

    .portfolio-table {
        width: 100%;
        border-collapse: collapse;
    }

    .portfolio-table th {
        background: #f8fafc;
        padding: 1rem 1.5rem;
        text-align: left;
        font-weight: 600;
        color: #374151;
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        border-bottom: 1px solid #e5e7eb;
    }

    .portfolio-table td {
        padding: 1rem 1.5rem;
        border-bottom: 1px solid #f1f5f9;
        font-size: 0.875rem;
    }

    .portfolio-table tr:hover {
        background: #f8fafc;
    }

    .portfolio-table tr:last-child td {
        border-bottom: none;
    }

    /* Coin Info */
    .coin-info {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .coin-logo {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 0.75rem;
        color: white;
    }

    .coin-name {
        display: flex;
        flex-direction: column;
    }

    .coin-symbol {
        font-weight: 600;
        color: #1f2937;
    }

    .coin-full-name {
        font-size: 0.75rem;
        color: #6b7280;
    }

    /* Performance Indicators */
    .performance-indicator {
        font-weight: 600;
        padding: 0.25rem 0.75rem;
        border-radius: 6px;
        font-size: 0.875rem;
    }

    .performance-positive {
        background: #ecfdf5;
        color: #059669;
    }

    .performance-negative {
        background: #fef2f2;
        color: #dc2626;
    }

    /* Sidebar Widgets */
    .portfolio-sidebar {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    .widget {
        background: white;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }

    .widget-header {
        padding: 1.25rem 1.5rem;
        border-bottom: 1px solid #e5e7eb;
    }

    .widget-header h3 {
        font-size: 1.125rem;
        font-weight: 600;
        color: #1f2937;
        margin: 0;
    }

    .widget-body {
        padding: 1.5rem;
    }

    /* Allocation Chart */
    .allocation-chart-container {
        position: relative;
        height: 250px;
    }

    /* Performance Chart */
    .performance-chart-container {
        position: relative;
        height: 300px;
    }

    .chart-controls {
        display: flex;
        gap: 1rem;
        align-items: center;
        margin-top: 1rem;
    }

    .timeframe-selector {
        display: flex;
        gap: 0.5rem;
    }

    .timeframe-btn {
        padding: 0.5rem 1rem;
        border: 1px solid #e5e7eb;
        background: white;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 0.875rem;
    }

    .timeframe-btn.active {
        background: #667eea;
        color: white;
        border-color: #667eea;
    }

    /* Risk Metrics */
    .risk-metrics {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
    }

    .risk-metric {
        text-align: center;
        padding: 1rem;
        background: #f8fafc;
        border-radius: 8px;
    }

    .risk-value {
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: 0.25rem;
    }

    .risk-label {
        font-size: 0.75rem;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .risk-low { color: #10b981; }
    .risk-medium { color: #f59e0b; }
    .risk-high { color: #ef4444; }

    /* Insights Panel */
    .insights-list {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .insight-item {
        padding: 1rem;
        background: #f0f9ff;
        border-radius: 8px;
        border-left: 4px solid #667eea;
        font-size: 0.875rem;
        line-height: 1.5;
    }

    .insight-item.warning {
        background: #fef3c7;
        border-left-color: #f59e0b;
    }

    .insight-item.success {
        background: #ecfdf5;
        border-left-color: #10b981;
    }

    /* Loading States */
    .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 2px solid #f3f4f6;
        border-top: 2px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 3rem 2rem;
        color: #6b7280;
    }

    .empty-state-icon {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .portfolio-summary {
            grid-template-columns: 1fr;
        }

        .card-value {
            font-size: 1.5rem;
        }

        .table-header {
            flex-direction: column;
            gap: 1rem;
            align-items: stretch;
        }

        .portfolio-table {
            display: block;
            overflow-x: auto;
        }

        .chart-controls {
            flex-direction: column;
            align-items: stretch;
        }

        .timeframe-selector {
            justify-content: center;
        }

        .risk-metrics {
            grid-template-columns: 1fr;
        }
    }

    /* Connection Status */
    .connection-status {
        position: fixed;
        top: 10px;
        right: 10px;
        padding: 5px 10px;
        border-radius: 15px;
        font-size: 12px;
        font-weight: 600;
        z-index: 1000;
    }

    .connection-status.connected {
        background: #10b981;
        color: white;
    }

    .connection-status.disconnected {
        background: #6b7280;
        color: white;
    }

    .connection-status.error {
        background: #ef4444;
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<div class="portfolio-page">
    <!-- Portfolio Summary Cards -->
    <div class="portfolio-summary">
        <div class="summary-card">
            <div class="card-label">Total Portfolio Value</div>
            <div class="card-value" id="total-value">$0.00</div>
            <div class="card-change positive" id="daily-change">+0.00%</div>
        </div>
        
        <div class="summary-card performance">
            <div class="card-label">Unrealized P/L</div>
            <div class="card-value" id="unrealized-pl">$0.00</div>
            <div class="card-change" id="pl-percentage">0.00%</div>
        </div>
        
        <div class="summary-card risk">
            <div class="card-label">Risk Score</div>
            <div class="card-value" id="risk-score">0/100</div>
            <div class="card-label" id="risk-level">Low Risk</div>
        </div>
        
        <div class="summary-card allocation">
            <div class="card-label">Diversification</div>
            <div class="card-value" id="diversification-score">100%</div>
            <div class="card-label">Well Diversified</div>
        </div>
    </div>

    <!-- Main Portfolio Layout -->
    <div class="portfolio-layout">
        <!-- Left Column: Holdings Table & Performance Chart -->
        <div class="portfolio-main">
            <!-- Performance Chart -->
            <div class="widget">
                <div class="widget-header">
                    <h3>Portfolio Performance</h3>
                    <div class="chart-controls">
                        <div class="timeframe-selector">
                            <button class="timeframe-btn active" data-timeframe="1D">1D</button>
                            <button class="timeframe-btn" data-timeframe="1W">1W</button>
                            <button class="timeframe-btn" data-timeframe="1M">1M</button>
                            <button class="timeframe-btn" data-timeframe="3M">3M</button>
                            <button class="timeframe-btn" data-timeframe="1Y">1Y</button>
                        </div>
                    </div>
                </div>
                <div class="widget-body">
                    <div class="performance-chart-container">
                        <canvas id="performanceChart"></canvas>
                        <div id="performance-loading" style="display: none; text-align: center; padding: 2rem;">
                            <div class="loading-spinner"></div>
                            <div>Loading performance data...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Holdings Table -->
            <div class="holdings-container">
                <div class="table-header">
                    <h2>Your Holdings</h2>
                    <button class="btn-primary" id="add-transaction-btn">
                        + Add Transaction
                    </button>
                </div>
                <div class="table-container">
                    <table class="portfolio-table">
                        <thead>
                            <tr>
                                <th>Asset</th>
                                <th>Holdings</th>
                                <th>Price</th>
                                <th>Value</th>
                                <th>Allocation</th>
                                <th>P/L</th>
                                <th>24h Change</th>
                            </tr>
                        </thead>
                        <tbody id="holdings-table-body">
                            <!-- Holdings will be populated by JavaScript -->
                            <tr id="empty-holdings" style="display: none;">
                                <td colspan="7">
                                    <div class="empty-state">
                                        <div class="empty-state-icon">ðŸ’¼</div>
                                        <h3>No Holdings Yet</h3>
                                        <p>Start building your portfolio by adding your first transaction.</p>
                                        <button class="btn-primary" id="empty-add-btn">
                                            Add Your First Transaction
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Right Column: Sidebar Widgets -->
        <div class="portfolio-sidebar">
            <!-- Allocation Chart -->
            <div class="widget">
                <div class="widget-header">
                    <h3>Portfolio Allocation</h3>
                </div>
                <div class="widget-body">
                    <div class="allocation-chart-container">
                        <canvas id="allocationChart"></canvas>
                        <div id="allocation-loading" style="display: none; text-align: center; padding: 2rem;">
                            <div class="loading-spinner"></div>
                            <div>Loading allocation data...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Risk Metrics -->
            <div class="widget">
                <div class="widget-header">
                    <h3>Risk Analysis</h3>
                </div>
                <div class="widget-body">
                    <div class="risk-metrics">
                        <div class="risk-metric">
                            <div class="risk-value risk-low" id="volatility-value">0%</div>
                            <div class="risk-label">Volatility</div>
                        </div>
                        <div class="risk-metric">
                            <div class="risk-value risk-low" id="diversification-value">100%</div>
                            <div class="risk-label">Diversification</div>
                        </div>
                        <div class="risk-metric">
                            <div class="risk-value risk-low" id="max-drawdown-value">0%</div>
                            <div class="risk-label">Max Drawdown</div>
                        </div>
                        <div class="risk-metric">
                            <div class="risk-value risk-low" id="sharpe-value">0.00</div>
                            <div class="risk-label">Sharpe Ratio</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AI Insights -->
            <div class="widget">
                <div class="widget-header">
                    <h3>AI Insights & Recommendations</h3>
                </div>
                <div class="widget-body">
                    <div class="insights-list" id="insights-list">
                        <div class="insight-item">
                            <strong>Welcome to Your Portfolio!</strong><br>
                            Start by adding your cryptocurrency transactions to see personalized insights and recommendations.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Transaction Modal -->
<div id="transaction-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Add Transaction</h3>
            <span class="close">&times;</span>
        </div>
        <div class="modal-body">
            <form id="transaction-form">
                {% csrf_token %}
                <div class="form-group">
                    <label>Transaction Type</label>
                    <select name="type" id="transaction-type" required>
                        <option value="BUY">Buy</option>
                        <option value="SELL">Sell</option>
                        <option value="DEPOSIT">Deposit</option>
                        <option value="WITHDRAWAL">Withdrawal</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Cryptocurrency</label>
                    <select name="symbol" id="transaction-symbol" required>
                        <option value="">Select cryptocurrency</option>
                        {% for crypto in cryptocurrencies %}
                        <option value="{{ crypto.symbol }}">{{ crypto.symbol }} - {{ crypto.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Amount</label>
                    <input type="number" name="amount" step="0.00000001" placeholder="0.00000000" required 
                           id="transaction-amount">
                </div>
                
                <div class="form-group">
                    <label>Price per Coin (USD)</label>
                    <input type="number" name="price" step="0.01" placeholder="0.00" required 
                           id="transaction-price">
                </div>
                
                <div class="form-group">
                    <label>Total Amount (USD)</label>
                    <input type="number" name="total_amount" step="0.01" placeholder="0.00" required 
                           id="transaction-total">
                </div>
                
                <div class="form-group">
                    <label>Fee (USD)</label>
                    <input type="number" name="fee" step="0.01" placeholder="0.00" value="0.00" 
                           id="transaction-fee">
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn-secondary" id="cancel-transaction">Cancel</button>
                    <button type="submit" class="btn-primary">Add Transaction</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{% static 'js/portfolio.js' %}"></script>
<script src="{% static 'js/portfolioCharts.js' %}"></script>
<script src="{% static 'js/portfolioSocket.js' %}"></script>
{% endblock %}