{% extends 'jobs/admin_templates/base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Dashboard - VENEX Brokerage{% endblock %}

{% block extra_css %}
   <link rel="stylesheet" href="{% static 'assets/css/dashboard.css' %}">  
    {% endblock %}

    {% block main_content%}
    {% comment %} <div class="connection-status connected" id="connectionStatus">
        Connected
    </div> {% endcomment %}

    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="h3 mb-1">Welcome back, {{ user.first_name }}!</h1>
            <p class="text">Here's what's happening with your account today.</p>
        </div>
    </div>


    <!-- Portfolio Overview -->
    <div class="portfolio-overview">
        <div class="portfolio-content">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <div class="d-flex align-items-baseline gap-4">
                        <div>
                            <h5>Total Portfolio Value</h5>
                            <div class="portfolio-value digital-display">
                                ${{ total_balance|floatformat:2|intcomma }}
                            </div>
                            <div class="portfolio-change {% if total_profit_loss >= 0 %}positive{% else %}negative{% endif %}">
                                <i class="fas fa-{% if total_profit_loss >= 0 %}arrow-up{% else %}arrow-down{% endif %}"></i>
                                <span>{% if total_profit_loss >= 0 %}+{% endif %}${{ total_profit_loss|floatformat:2|intcomma }} ({{ total_profit_loss_pct|floatformat:2 }}%)</span>
                            </div>
                        </div>
                        <div class="vr" style="height: 80px; opacity: 0.2;"></div>
                        <div>
                            <h5>Available Balance</h5>
                            <div class="portfolio-value digital-display" style="font-size: 2rem;">
                                {% if user.currency_type != 'USD' %}
                                    {{ user.get_currency_symbol }}{{ user.currency_balance|floatformat:2|intcomma }}
                                {% else %}
                                    ${{ user.currency_balance|floatformat:2|intcomma }}
                                {% endif %}
                            </div>
                            <div class="portfolio-change" style="opacity: 0.6;">
                                <i class="fas fa-wallet"></i>
                                <span>Cash Balance</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 text-md-end mt-3 mt-md-0">
                    <a href="{% url 'buy' %}" class="btn btn-light me-2">
                        <i class="fas fa-plus"></i> Buy Crypto
                    </a>
                    <a href="{% url 'deposit' %}" class="btn btn-outline-light">
                        <i class="fas fa-arrow-down"></i> Deposit
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Asset Breakdown -->
    <div class="asset-breakdown">
        <div class="section-header">
            <h2>Asset Breakdown</h2>
        </div>
        <div class="asset-grid">
            {% for symbol, data in crypto_balances.items %}
            <div class="asset-card">
                <div class="asset-icon" style="background: {% if symbol == 'BTC' %}#f7931a{% elif symbol == 'ETH' %}#627eea{% elif symbol == 'USDT' %}#26a17b{% elif symbol == 'LTC' %}#345d9d{% else %}#eb0029{% endif %};">
                    {{ symbol|slice:":1" }}
                </div>
                <h6 class="mb-1">{{ symbol }}</h6>
                <div class="h5 mb-1 digital-display">${{ data.value|floatformat:2|intcomma }}</div>
                <div class="price-change {% if data.change_percentage_24h >= 0 %}positive{% else %}negative{% endif %} small">
                    {% if data.change_percentage_24h >= 0 %}+{% endif %}{{ data.change_percentage_24h|floatformat:2|intcomma }}%
                </div>
                <div class="mt-2">
                    <small class="text">{{ data.balance|floatformat:4|intcomma }} {{ symbol }}</small>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>


    <div class="live_market" id="live_market">
        <div class="market-header">
            <h1>Live Cryptocurrency Market</h1>
            <p>Real-time digital asset prices and statistics</p>
        </div>

        <div class="market-stats">
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-label">Active Cryptocurrencies</div>
                    <div class="stat-value digital-display" id="activeCryptos"></div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Total Market Cap</div>
                    <div class="stat-value digital-display" id="totalMarketCap">$</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">24h Volume</div>
                    <div class="stat-value digital-display" id="totalVolume">$</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">BTC Dominance</div>
                    <div class="stat-value digital-display" id="btcDominance"></div>
                </div>
            </div>
        </div>

            <!-- Pass initial market stats from backend context to JS -->
            <script>
                window.initialMarketStats = {
                    activeCryptos: {{ market_overview.active_cryptocurrencies|default:'0' }},
                    totalMarketCap: '{{ market_overview.total_market_cap|default:"0" }}',
                    totalVolume: '{{ market_overview.total_volume_24h|default:"0" }}',
                    btcDominance: '{{ market_overview.btc_dominance|default:"0" }}',
                    lastUpdated: '{{ market_overview.last_updated|default:"--" }}'
                };
            </script>

        <div class="crypto-grid" id="cryptoGrid">
            <!-- Crypto cards will be dynamically populated by JavaScript -->
        </div>

        <div class="last-updated" id="lastUpdated">
            Last updated: <span id="updateTime">--</span>
        </div>
    </div>
    <!-- Trading Section Grid -->
    <div class="dashboard-grid">
        <!-- QUICK TRADE -->
        <div class="dashboard-card quick-trade">
            <div class="card-header">
                <h3>Quick Trade</h3>
                <div class="trade-type-toggle">
                    <button class="trade-btn active" data-type="buy">Buy</button>
                    <button class="trade-btn" data-type="sell">Sell</button>
                </div>
            </div>
            <div class="card-body">
                <form id="quickTradeForm" class="trade-form">
                    <div class="form-group">
                        <label>Select Cryptocurrency</label>
                        <select class="form-control" name="cryptocurrency" required>
                            {% for symbol, data in crypto_balances.items %}
                                <option value="{{ symbol }}">{{ symbol }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Amount (USD)</label>
                        <input type="number" class="form-control" name="amount" placeholder="Enter amount" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Place Order</button>
                </form>
            </div>
        </div>

        <!-- OPEN ORDERS -->
        <div class="dashboard-card open-orders">
            <div class="card-header">
                <h3>Open Orders</h3>
                <a href="{% url 'orders_view' %}" class="btn btn-outline-primary btn-sm">View All</a>
            </div>
            <div class="card-body">
                {% if open_orders %}
                    <div class="orders-list">
                        {% for order in open_orders %}
                            <div class="order-item">
                                <div class="order-info">
                                    <span class="order-type {{ order.side|lower }}">{{ order.side }}</span>
                                    <span class="order-amount">{{ order.quantity }} {{ order.cryptocurrency.symbol }}</span>
                                </div>
                                <div class="order-price">
                                    <span>${{ order.price|floatformat:2|intcomma }}</span>
                                    <span class="order-date">{{ order.created_at|date:"M d, H:i" }}</span>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="no-orders">
                        <i class="fas fa-clipboard-list"></i>
                        <p>No open orders</p>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- MARKET SUMMARY -->
        <div class="dashboard-card market-summary">
            <div class="card-header">
                <h3>Market Analysis</h3>
                <span class="refresh-time" id="analysisTime">Updated: {% now "H:i" %}</span>
            </div>
            <div class="card-body">
                <div class="market-analysis">
                    <div class="market-sentiment">
                        <h4>Market Sentiment</h4>
                        <div class="sentiment-indicator">
                            {% if total_profit_loss_pct >= 0 %}
                                <span class="badge bg-success">Bullish</span>
                            {% else %}
                                <span class="badge bg-danger">Bearish</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="top-performers">
                        <h4>Top Performer</h4>
                        {% for symbol, data in crypto_balances.items %}
                            {% if forloop.first %}
                                <div class="performer">
                                    <span class="symbol">{{ symbol }}</span>
                                    <span class="change positive">+{{ data.change_percentage_24h|floatformat:2 }}%</span>
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
                <div class="market-recommendation">
                    <p class="recommendation-text">
                        {% if total_profit_loss_pct >= 0 %}
                            Market showing strong momentum. Consider strategic buying opportunities while maintaining risk management.
                        {% else %}
                            Market experiencing volatility. Focus on portfolio protection and consider averaging positions.
                        {% endif %}
                    </p>
                </div>
            </div>
        </div>

        <!-- RECENT TRANSACTIONS -->
        <div class="dashboard-card recent-transactions">
            <div class="card-header">
                <h3>Recent Transactions</h3>
                <a href="{% url 'transaction_history_view' %}" class="btn btn-outline-primary btn-sm">
                    <i class="fas fa-history"></i> View All
                </a>
            </div>
            <div class="card-body">
                {% if recent_transactions %}
                    <div class="transactions-list">
                        {% for transaction in recent_transactions|slice:":4" %}
                            <div class="transaction-item">
                                <div class="transaction-icon {% if transaction.transaction_type == 'BUY' %}buy{% elif transaction.transaction_type == 'SELL' %}sell{% else %}transfer{% endif %}">
                                    <i class="fas fa-{% if transaction.transaction_type == 'BUY' %}arrow-down{% elif transaction.transaction_type == 'SELL' %}arrow-up{% else %}exchange-alt{% endif %}"></i>
                                </div>
                                <div class="transaction-details">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            <div class="transaction-type">
                                                <strong>{{ transaction.transaction_type }}</strong> {{ transaction.cryptocurrency.symbol }}
                                            </div>
                                            <div class="transaction-amount" style="font-size: 0.95rem; margin-top: 0.25rem;">
                                                {{ transaction.quantity|floatformat:6}} {{ transaction.cryptocurrency.symbol }}
                                            </div>
                                        </div>
                                        <div class="text-end">
                                            <div class="transaction-amount" style="font-weight: 600; font-size: 1rem;">
                                                {% if transaction.fiat_amount %}
                                                    {% if user.currency_type != 'USD' %}
                                                        {{ user.get_currency_symbol }}{{ transaction.fiat_amount|floatformat:2|intcomma }}
                                                        <small style="font-size: 0.75em; opacity: 0.7; margin-left: 2px;">{{ user.currency_type }}</small>
                                                    {% else %}
                                                        ${{ transaction.fiat_amount|floatformat:2|intcomma }}
                                                    {% endif %}
                                                {% elif transaction.total_amount %}
                                                    ${{ transaction.total_amount|floatformat:2|intcomma }}
                                                {% else %}
                                                    <span style="opacity: 0.5;">N/A</span>
                                                {% endif %}
                                            </div>
                                            <div class="transaction-status mt-1">
                                                <span class="badge bg-{% if transaction.status == 'COMPLETED' %}success{% elif transaction.status == 'PENDING' %}warning{% else %}danger{% endif %}">
                                                    {{ transaction.status }}
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="transaction-time" style="margin-top: 0.5rem; font-size: 0.8rem; opacity: 0.7;">
                                        <i class="fas fa-clock"></i> {{ transaction.created_at|date:"M d, Y H:i" }}
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="no-transactions">
                        <i class="fas fa-history"></i>
                        <p>No recent transactions</p>
                        <a href="{% url 'buy' %}" class="btn btn-primary btn-sm mt-2">
                            <i class="fas fa-shopping-cart"></i> Start Trading
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endblock %}

{% block extra_js %}
<!-- WebSocket real-time updates (PythonAnywhere paid plan supports WebSockets) -->
<script src="{% static 'assets/js/venex-dashboard.js' %}"></script>
{% endblock %}