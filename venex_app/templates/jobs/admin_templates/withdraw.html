{% extends 'admin_templates/base.html' %}
{% load humanize %}
{% load static %}

{% block title %}Venex - Withdraw Funds{% endblock title %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'assets/css/withdraw.css' %}">
{% endblock %}

{% block main_content %}
<div class="withdraw-container">
    <!-- Hero Section -->
    <div class="withdraw-hero">
        <div class="hero-content">
            <h1 class="hero-title">
                <i class="fas fa-arrow-circle-down"></i>
                Withdraw Funds
            </h1>
            <p class="hero-subtitle">Securely withdraw your cryptocurrency to any wallet address</p>
        </div>
        
        <!-- Balance Cards -->
        <div class="balance-cards-grid">
            <!-- Fiat Balance Card -->
            <div class="balance-card fiat-card">
                <div class="balance-card-icon">
                    <i class="fas fa-wallet"></i>
                </div>
                <div class="balance-card-content">
                    <span class="balance-label">Fiat Balance</span>
                    <span class="balance-amount">
                        {{ user.get_currency_symbol }}
                        <span id="fiat-balance">{{ user.currency_balance|floatformat:2|intcomma }}</span>
                    </span>
                    <span class="balance-currency">{{ user.currency_type }}</span>
                </div>
            </div>
            
            <!-- Total Crypto Balance Card -->
            <div class="balance-card crypto-card">
                <div class="balance-card-icon">
                    <i class="fas fa-coins"></i>
                </div>
                <div class="balance-card-content">
                    <span class="balance-label">Total Crypto Value</span>
                    <span class="balance-amount">
                        {{ user.get_currency_symbol }}
                        <span id="total-crypto-value">--</span>
                    </span>
                    <span class="balance-currency">{{ user.currency_type }}</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Crypto Balances Section -->
    <div class="crypto-balances-section">
        <h2 class="section-title">Your Cryptocurrency Balances</h2>
        
        <div class="crypto-balances-grid">
            <!-- Bitcoin Balance -->
            <div class="crypto-balance-card">
                <div class="crypto-header">
                    <div class="crypto-icon btc-icon">₿</div>
                    <div class="crypto-info">
                        <h3>Bitcoin</h3>
                        <span class="crypto-symbol">BTC</span>
                    </div>
                </div>
                <div class="crypto-balance">
                    <span class="balance-amount">{{ user.btc_balance|floatformat:8 }}</span>
                    <span class="balance-label">BTC</span>
                </div>
                <div class="crypto-value" id="btc-value">≈ $0.00</div>
                <button class="withdraw-btn" onclick="showWithdrawModal('BTC')" {% if user.btc_balance <= 0 %}disabled{% endif %}>
                    <i class="fas fa-arrow-down"></i> Withdraw
                </button>
            </div>
            
            <!-- Ethereum Balance -->
            <div class="crypto-balance-card">
                <div class="crypto-header">
                    <div class="crypto-icon eth-icon">Ξ</div>
                    <div class="crypto-info">
                        <h3>Ethereum</h3>
                        <span class="crypto-symbol">ETH</span>
                    </div>
                </div>
                <div class="crypto-balance">
                    <span class="balance-amount">{{ user.ethereum_balance|floatformat:8 }}</span>
                    <span class="balance-label">ETH</span>
                </div>
                <div class="crypto-value" id="eth-value">≈ $0.00</div>
                <button class="withdraw-btn" onclick="showWithdrawModal('ETH')" {% if user.ethereum_balance <= 0 %}disabled{% endif %}>
                    <i class="fas fa-arrow-down"></i> Withdraw
                </button>
            </div>
            
            <!-- USDT Balance -->
            <div class="crypto-balance-card">
                <div class="crypto-header">
                    <div class="crypto-icon usdt-icon">₮</div>
                    <div class="crypto-info">
                        <h3>Tether</h3>
                        <span class="crypto-symbol">USDT</span>
                    </div>
                </div>
                <div class="crypto-balance">
                    <span class="balance-amount">{{ user.usdt_balance|floatformat:2 }}</span>
                    <span class="balance-label">USDT</span>
                </div>
                <div class="crypto-value" id="usdt-value">≈ $0.00</div>
                <button class="withdraw-btn" onclick="showWithdrawModal('USDT')" {% if user.usdt_balance <= 0 %}disabled{% endif %}>
                    <i class="fas fa-arrow-down"></i> Withdraw
                </button>
            </div>
            
            <!-- Litecoin Balance -->
            <div class="crypto-balance-card">
                <div class="crypto-header">
                    <div class="crypto-icon ltc-icon">Ł</div>
                    <div class="crypto-info">
                        <h3>Litecoin</h3>
                        <span class="crypto-symbol">LTC</span>
                    </div>
                </div>
                <div class="crypto-balance">
                    <span class="balance-amount">{{ user.litecoin_balance|floatformat:8 }}</span>
                    <span class="balance-label">LTC</span>
                </div>
                <div class="crypto-value" id="ltc-value">≈ $0.00</div>
                <button class="withdraw-btn" onclick="showWithdrawModal('LTC')" {% if user.litecoin_balance <= 0 %}disabled{% endif %}>
                    <i class="fas fa-arrow-down"></i> Withdraw
                </button>
            </div>
            
            <!-- Tron Balance -->
            <div class="crypto-balance-card">
                <div class="crypto-header">
                    <div class="crypto-icon trx-icon">⚡</div>
                    <div class="crypto-info">
                        <h3>Tron</h3>
                        <span class="crypto-symbol">TRX</span>
                    </div>
                </div>
                <div class="crypto-balance">
                    <span class="balance-amount">{{ user.tron_balance|floatformat:8 }}</span>
                    <span class="balance-label">TRX</span>
                </div>
                <div class="crypto-value" id="trx-value">≈ $0.00</div>
                <button class="withdraw-btn" onclick="showWithdrawModal('TRX')" {% if user.tron_balance <= 0 %}disabled{% endif %}>
                    <i class="fas fa-arrow-down"></i> Withdraw
                </button>
            </div>
        </div>
    </div>

    <!-- Recent Withdrawals -->
    <div class="recent-withdrawals-section">
        <div class="section-header">
            <h2 class="section-title">Recent Withdrawals</h2>
            <div class="section-header-actions">
                <button class="refresh-btn" onclick="loadRecentWithdrawals()">
                    <i class="fas fa-sync-alt"></i>
                    Refresh
                </button>
                <a href="{% url 'transaction_history_view' %}" class="view-all-btn">
                    View All
                    <i class="fas fa-arrow-right"></i>
                </a>
            </div>
        </div>
        
        <div class="withdrawals-grid" id="withdrawals-grid">
            <div class="loading-state">
                <i class="fas fa-spinner fa-spin"></i>
                <p>Loading withdrawals...</p>
            </div>
        </div>
        
        <div class="empty-state" id="withdrawals-empty-state" style="display: none;">
            <i class="fas fa-inbox"></i>
            <h3>No Withdrawals Yet</h3>
            <p>Your withdrawal history will appear here</p>
        </div>
    </div>
</div>

<!-- Withdraw Modal -->
<div class="modal withdraw-modal" id="withdrawModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>
                <i class="fas fa-arrow-circle-down"></i>
                Withdraw <span id="modal-crypto-name">Cryptocurrency</span>
            </h2>
            <button class="modal-close" onclick="closeWithdrawModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="modal-body">
            {% csrf_token %}
            <form id="withdraw-form">
                <!-- Step 1: Enter Details -->
                <div class="form-step active" id="withdraw-step-1">
                    <div class="step-header">
                        <span class="step-number">1</span>
                        <h3>Withdrawal Details</h3>
                    </div>
                    
                    <!-- Selected Crypto Info -->
                    <div class="selected-crypto-info" id="selected-crypto-info">
                        <div class="crypto-info-icon" id="crypto-info-icon">₿</div>
                        <div class="crypto-info-details">
                            <span class="crypto-info-name" id="crypto-info-name">Bitcoin</span>
                            <div class="crypto-info-balance">
                                Available: <span id="crypto-info-balance">0.00000000</span> <span id="crypto-info-symbol">BTC</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Wallet Address Input -->
                    <div class="form-group">
                        <label>
                            <i class="fas fa-wallet"></i>
                            Recipient Wallet Address
                        </label>
                        <input 
                            type="text" 
                            id="wallet-address" 
                            name="wallet_address" 
                            placeholder="Enter wallet address"
                            required
                        >
                        <div class="input-helper">
                            <span class="helper-text">
                                <i class="fas fa-info-circle"></i>
                                Make sure the address matches your selected cryptocurrency
                            </span>
                        </div>
                    </div>
                    
                    <!-- Amount Input -->
                    <div class="form-group">
                        <label>
                            <i class="fas fa-coins"></i>
                            Amount to Withdraw
                        </label>
                        <div class="input-with-symbol">
                            <input 
                                type="number" 
                                id="withdraw-amount" 
                                name="amount" 
                                step="0.00000001" 
                                min="0" 
                                placeholder="0.00000000"
                                required
                            >
                            <span class="input-symbol" id="withdraw-crypto-symbol">BTC</span>
                        </div>
                        <div class="amount-helpers">
                            <button type="button" class="amount-preset-btn" onclick="setWithdrawAmount(25)">25%</button>
                            <button type="button" class="amount-preset-btn" onclick="setWithdrawAmount(50)">50%</button>
                            <button type="button" class="amount-preset-btn" onclick="setWithdrawAmount(75)">75%</button>
                            <button type="button" class="amount-preset-btn" onclick="setWithdrawAmount(100)">MAX</button>
                        </div>
                        <div class="input-helper">
                            <span class="helper-text" id="min-withdraw">Minimum: --</span>
                            <span class="helper-text fiat-equivalent" id="withdraw-fiat-equivalent">≈ $0.00</span>
                        </div>
                    </div>
                    
                    <!-- Network Fee Warning -->
                    <div class="info-box">
                        <i class="fas fa-info-circle"></i>
                        <div>
                            <strong>Network Fee:</strong>
                            <p>A small network fee will be deducted from your withdrawal amount to cover blockchain transaction costs.</p>
                        </div>
                    </div>
                    
                    <button type="button" class="modal-btn primary" onclick="reviewWithdrawal()">
                        Review Withdrawal <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
                
                <!-- Step 2: Review & Confirm -->
                <div class="form-step" id="withdraw-step-2">
                    <div class="step-header">
                        <button type="button" class="back-btn" onclick="previousWithdrawStep()">
                            <i class="fas fa-arrow-left"></i> Back
                        </button>
                        <div>
                            <span class="step-number">2</span>
                            <h3>Review & Confirm</h3>
                        </div>
                    </div>
                    
                    <div class="review-section">
                        <h4>Withdrawal Summary</h4>
                        
                        <div class="review-item">
                            <span class="review-label">Cryptocurrency:</span>
                            <span class="review-value" id="review-crypto">Bitcoin (BTC)</span>
                        </div>
                        
                        <div class="review-item">
                            <span class="review-label">Amount:</span>
                            <span class="review-value" id="review-amount">0.00000000 BTC</span>
                        </div>
                        
                        <div class="review-item">
                            <span class="review-label">USD Equivalent:</span>
                            <span class="review-value" id="review-usd">$0.00</span>
                        </div>
                        
                        <div class="review-divider"></div>
                        
                        <div class="review-item">
                            <span class="review-label">Recipient Address:</span>
                            <span class="review-value address-value" id="review-address">--</span>
                        </div>
                        
                        <div class="review-divider"></div>
                        
                        <div class="review-item highlight">
                            <span class="review-label">You will receive:</span>
                            <span class="review-value" id="review-final-amount">~0.00000000 BTC</span>
                        </div>
                        
                        <div class="review-note">
                            <i class="fas fa-exclamation-triangle"></i>
                            <small>The actual amount received may vary slightly due to network fees.</small>
                        </div>
                    </div>
                    
                    <div class="warning-box">
                        <i class="fas fa-exclamation-triangle"></i>
                        <div>
                            <strong>Warning:</strong>
                            <p>Please double-check the wallet address. Cryptocurrency transactions are irreversible.</p>
                        </div>
                    </div>
                    
                    <button type="button" class="modal-btn primary" onclick="submitWithdrawal()">
                        <i class="fas fa-check-circle"></i>
                        Confirm Withdrawal
                    </button>
                </div>
                
                <!-- Step 3: Success -->
                <div class="form-step" id="withdraw-step-3">
                    <div class="step-header">
                        <span class="step-number">3</span>
                        <h3>Withdrawal Submitted</h3>
                    </div>
                    
                    <div class="success-message">
                        <i class="fas fa-check-circle"></i>
                        <h3>Withdrawal Request Submitted!</h3>
                        <p>Your withdrawal is being processed by our team.</p>
                    </div>
                    
                    <div class="success-details">
                        <div class="detail-item">
                            <span class="detail-label">Transaction ID:</span>
                            <code id="success-transaction-id">--</code>
                        </div>
                        
                        <div class="detail-item">
                            <span class="detail-label">Amount:</span>
                            <span id="success-amount">0.00000000 BTC</span>
                        </div>
                        
                        <div class="detail-item">
                            <span class="detail-label">Status:</span>
                            <span class="status-badge pending">Pending</span>
                        </div>
                    </div>
                    
                    <div class="info-box">
                        <i class="fas fa-info-circle"></i>
                        <div>
                            <strong>What's Next?</strong>
                            <ul>
                                <li>Your withdrawal request is under review</li>
                                <li>Processing typically takes 10-30 minutes</li>
                                <li>You'll receive an email notification once processed</li>
                                <li>Track your withdrawal in transaction history</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="success-actions">
                        <button type="button" class="modal-btn secondary" onclick="closeWithdrawModal()">
                            <i class="fas fa-times"></i> Close
                        </button>
                        <a href="{% url 'transaction_history_view' %}" class="modal-btn primary">
                            <i class="fas fa-history"></i> View History
                        </a>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Toast Notification Container -->
<div class="toast-container" id="toast-container"></div>

{% endblock main_content %}

{% block extra_js %}
<script src="{% static 'assets/js/withdraw.js' %}"></script>
<script src="{% static 'assets/js/withdrawSocket.js' %}"></script>
{% endblock %}
