{% extends 'jobs/admin_templates/base.html' %}
{% load humanize %}
{% load static %}

{% block title %}VENEX | Market{% endblock %}

{% block extra_css %}
<style>
    .market-page {
        padding: 0;
    }

    /* Market Stats Header */
    .market-stats-bar {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1.5rem 2rem;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 2rem;
        border-radius: 12px;
        margin-bottom: 2rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .market-stat {
        text-align: center;
    }

    .market-stat .label {
        display: block;
        font-size: 0.875rem;
        opacity: 0.9;
        margin-bottom: 0.5rem;
        font-weight: 500;
    }

    .market-stat .value {
        display: block;
        font-size: 1.5rem;
        font-weight: 700;
    }

    /* Main Layout */
    .market-layout {
        display: grid;
        grid-template-columns: 1fr 400px;
        gap: 2rem;
        margin-bottom: 2rem;
    }

    @media (max-width: 1200px) {
        .market-layout {
            grid-template-columns: 1fr;
        }
    }

    /* Crypto Table */
    .crypto-table-container {
        background: white;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }

    .table-header {
        padding: 1.5rem;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .table-header h2 {
        font-size: 1.5rem;
        font-weight: 600;
        color: #1f2937;
        margin: 0;
    }

    .search-box {
        padding: 0.75rem 1rem;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        width: 300px;
        font-size: 0.875rem;
    }

    .search-box:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .market-table {
        width: 100%;
        border-collapse: collapse;
    }

    .market-table th {
        background: #f8fafc;
        padding: 1rem 1.5rem;
        text-align: left;
        font-weight: 600;
        color: #374151;
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        border-bottom: 1px solid #e5e7eb;
    }

    .market-table td {
        padding: 1rem 1.5rem;
        border-bottom: 1px solid #f1f5f9;
        font-size: 0.875rem;
    }

    .market-table tr:hover {
        background: #f8fafc;
    }

    .market-table tr:last-child td {
        border-bottom: none;
    }

    /* Coin Info */
    .coin-info {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .coin-logo {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: #f1f5f9;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 0.75rem;
        color: #64748b;
    }

    .coin-name {
        display: flex;
        flex-direction: column;
    }

    .coin-symbol {
        font-weight: 600;
        color: #1f2937;
    }

    .coin-full-name {
        font-size: 0.75rem;
        color: #6b7280;
    }

    /* Price Changes */
    .price-change {
        font-weight: 600;
        padding: 0.25rem 0.75rem;
        border-radius: 6px;
        font-size: 0.875rem;
    }

    .price-change.positive {
        background: #ecfdf5;
        color: #059669;
    }

    .price-change.negative {
        background: #fef2f2;
        color: #dc2626;
    }

    /* Sidebar Widgets */
    .market-sidebar {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    .widget {
        background: white;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }

    .widget-header {
        padding: 1.25rem 1.5rem;
        border-bottom: 1px solid #e5e7eb;
    }

    .widget-header h3 {
        font-size: 1.125rem;
        font-weight: 600;
        color: #1f2937;
        margin: 0;
    }

    .widget-body {
        padding: 1.5rem;
    }

    /* Gainers/Losers Lists */
    .gainers-list,
    .losers-list {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .gainer-item,
    .loser-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem;
        border-radius: 8px;
        transition: background-color 0.2s;
    }

    .gainer-item:hover,
    .loser-item:hover {
        background: #f8fafc;
    }

    .gainer-item {
        border-left: 3px solid #10b981;
    }

    .loser-item {
        border-left: 3px solid #ef4444;
    }

    .coin-mini-info {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .mini-logo {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background: #f1f5f9;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.625rem;
        font-weight: 600;
        color: #64748b;
    }

    /* Chart Widget */
    .chart-controls {
        display: flex;
        gap: 1rem;
        align-items: center;
        margin-top: 1rem;
    }

    .timeframe-selector {
        display: flex;
        gap: 0.5rem;
    }

    .timeframe-btn {
        padding: 0.5rem 1rem;
        border: 1px solid #e5e7eb;
        background: white;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 0.875rem;
    }

    .timeframe-btn.active {
        background: #667eea;
        color: white;
        border-color: #667eea;
    }

    #marketChart {
        width: 100%;
        height: 300px;
    }

    /* Loading States */
    .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 2px solid #f3f4f6;
        border-top: 2px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .market-stats-bar {
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            padding: 1rem;
        }

        .market-stat .value {
            font-size: 1.25rem;
        }

        .table-header {
            flex-direction: column;
            gap: 1rem;
            align-items: stretch;
        }

        .search-box {
            width: 100%;
        }

        .market-table {
            display: block;
            overflow-x: auto;
        }

        .chart-controls {
            flex-direction: column;
            align-items: stretch;
        }

        .timeframe-selector {
            justify-content: center;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="market-page">
    <!-- Market Stats Header -->
    <div class="market-stats-bar">
        <div class="market-stat">
            <span class="label">Global Market Cap</span>
            <span class="value" id="global-market-cap">${{ market_stats.total_market_cap|floatformat:0|intcomma }}</span>
        </div>
        <div class="market-stat">
            <span class="label">24h Volume</span>
            <span class="value" id="global-volume">${{ market_stats.total_volume_24h|floatformat:0|intcomma }}</span>
        </div>
        <div class="market-stat">
            <span class="label">BTC Dominance</span>
            <span class="value" id="btc-dominance">{{ market_stats.btc_dominance|floatformat:2 }}%</span>
        </div>
        <div class="market-stat">
            <span class="label">Active Coins</span>
            <span class="value" id="active-coins">{{ market_stats.active_cryptocurrencies|intcomma }}</span>
        </div>
    </div>

    <!-- Main Market Layout -->
    <div class="market-layout">
        <!-- Left Column: Crypto Table -->
        <div class="crypto-table-container">
            <div class="table-header">
                <h2>Cryptocurrencies</h2>
                <input type="text" class="search-box" placeholder="Search cryptocurrencies..." id="crypto-search">
            </div>
            <div class="table-container">
                <table class="market-table">
                    <thead>
                        <tr>
                            <th>Coin</th>
                            <th>Price</th>
                            <th>24h Change</th>
                            <th>24h High/Low</th>
                            <th>Market Cap</th>
                            <th>24h Volume</th>
                        </tr>
                    </thead>
                    <tbody id="crypto-table-body">
                        {% for crypto in cryptocurrencies %}
                        <tr class="crypto-row" data-symbol="{{ crypto.symbol }}">
                            <td>
                                <div class="coin-info">
                                    <div class="coin-logo">
                                        {{ crypto.symbol|slice:":3" }}
                                    </div>
                                    <div class="coin-name">
                                        <span class="coin-symbol">{{ crypto.symbol }}</span>
                                        <span class="coin-full-name">{{ crypto.name }}</span>
                                    </div>
                                </div>
                            </td>
                            <td class="price-cell">
                                <span class="current-price">${{ crypto.current_price|floatformat:2|intcomma }}</span>
                            </td>
                            <td>
                                <span class="price-change {% if crypto.price_change_percentage_24h >= 0 %}positive{% else %}negative{% endif %}">
                                    {% if crypto.price_change_percentage_24h >= 0 %}+{% endif %}{{ crypto.price_change_percentage_24h|floatformat:2 }}%
                                </span>
                            </td>
                            <td>
                                <!-- Placeholder for high/low - you might want to add these fields to your model -->
                                <span class="high-low">- / -</span>
                            </td>
                            <td>${{ crypto.market_cap|floatformat:0|intcomma }}</td>
                            <td>${{ crypto.volume_24h|floatformat:0|intcomma }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Right Column: Sidebar Widgets -->
        <div class="market-sidebar">
            <!-- Top Gainers -->
            <div class="widget gainers-widget">
                <div class="widget-header">
                    <h3>🟢 Top Gainers</h3>
                </div>
                <div class="widget-body">
                    <div class="gainers-list" id="top-gainers-list">
                        {% for gainer in top_gainers %}
                        <div class="gainer-item" data-symbol="{{ gainer.symbol }}">
                            <div class="coin-mini-info">
                                <div class="mini-logo">{{ gainer.symbol|slice:":3" }}</div>
                                <span class="coin-symbol">{{ gainer.symbol }}</span>
                            </div>
                            <div class="price-info">
                                <span class="price">${{ gainer.current_price|floatformat:2 }}</span>
                                <span class="change positive">+{{ gainer.price_change_percentage_24h|floatformat:2 }}%</span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Top Losers -->
            <div class="widget losers-widget">
                <div class="widget-header">
                    <h3>🔴 Top Losers</h3>
                </div>
                <div class="widget-body">
                    <div class="losers-list" id="top-losers-list">
                        {% for loser in top_losers %}
                        <div class="loser-item" data-symbol="{{ loser.symbol }}">
                            <div class="coin-mini-info">
                                <div class="mini-logo">{{ loser.symbol|slice:":3" }}</div>
                                <span class="coin-symbol">{{ loser.symbol }}</span>
                            </div>
                            <div class="price-info">
                                <span class="price">${{ loser.current_price|floatformat:2 }}</span>
                                <span class="change negative">{{ loser.price_change_percentage_24h|floatformat:2 }}%</span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Price Chart -->
            <div class="widget chart-widget">
                <div class="widget-header">
                    <h3>Price Chart</h3>
                    <div class="chart-controls">
                        <select id="chart-crypto-select">
                            {% for crypto in cryptocurrencies %}
                            <option value="{{ crypto.symbol }}" {% if crypto.symbol == 'BTC' %}selected{% endif %}>
                                {{ crypto.symbol }}
                            </option>
                            {% endfor %}
                        </select>
                        <div class="timeframe-selector">
                            <button class="timeframe-btn active" data-timeframe="1d">1D</button>
                            <button class="timeframe-btn" data-timeframe="1w">1W</button>
                            <button class="timeframe-btn" data-timeframe="1m">1M</button>
                            <button class="timeframe-btn" data-timeframe="3m">3M</button>
                            <button class="timeframe-btn" data-timeframe="1y">1Y</button>
                        </div>
                    </div>
                </div>
                <div class="widget-body">
                    <canvas id="marketChart" width="400" height="300"></canvas>
                    <div id="chart-loading" style="display: none; text-align: center; padding: 2rem;">
                        <div class="loading-spinner"></div>
                        <div>Loading chart data...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{% static 'js/market.js' %}"></script>
{% endblock %}